<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <!-- IE fix compitability -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title id='title'>SMYT-test of knowledge</title>

        <link rel="shortcut icon" type="image/x-icon" href="./img/favicon.ico">

        <!-- ** CSS ** -->
        <!-- base library -->
        <link rel="stylesheet" type="text/css" href="./extjs/resources/css/ext-all.css" />
        <link rel="stylesheet" type="text/css" href="./css/custom.css" />
        <!-- overrides to base library -->

        <!-- ** Javascript ** -->
        <!-- base library -->
        <script type="text/javascript" src="./extjs/adapter/ext/ext-base.js"></script>
        <script type="text/javascript" src="./extjs/ext-all-debug.js"></script>

        <!-- page specific -->

        <script type="text/javascript">
        Ext.BLANK_IMAGE_URL = './extjs/resources/images/default/s.gif';

        Ext.onReady(function(){
            //show tooltips
            Ext.QuickTips.init();

            // sample static data for the store
            var myData = [
                ['14-01-2012', 61, '13-04-2012', 90000.00, 7,  108000.00, 'погашен'],
                ['13-02-2012', 10, '18-04-2012', 70000.00, 10,  84000.00, 'выдан'],
                ['14-02-2012', 20, '14-04-2012', 91000.01, 7.1,  109000.1, 'погашен'],
                ['15-02-2012', 30, '15-04-2012', 92000.02, 7.01,  109000.02, 'погашен'],
                ['16-02-2012', 40, '16-04-2012', 93000.03, 7.02,  109000.03, 'погашен']
            ];


            // create the data store
            var store = new Ext.data.ArrayStore({
               fields: [
                    {name: 'startDate', type: 'date', dateFormat: 'd-m-Y'},
                    {name: 'loanTime', type: 'int'},
                    {name: 'endDate', type: 'date', dateFormat: 'd-m-Y'},
                    {name: 'loanBody',      type: 'number'},
                    {name: 'pct',     type: 'float'},
                    {name: 'totalPctSum',  type: 'number'},
                    {name: 'status'},

               ]
            });
            //console.log(store);

            // manually load local data
            store.loadData(myData);


            /**
             * Custom function used for column renderer
             * @param {Object} val
             */
            function daysChange(val) {
                if (val > 0) {
                    return val + ' ' + declOfNum(val, ['день', 'дня', 'дней']);
                }
                return val;
            }

            function declOfNum(number, titles)
            {
                cases = [2, 0, 1, 1, 1, 2];
                return titles[ (number%100>4 && number%100<20)? 2 : cases[(number%10<5)?number%10:5] ];
            }

            /**
             * Custom function used for column renderer
             * @param {Object} val
             */
            function thoursandSeparator(val) {
                //check if contains decimal
                if (val > Math.floor(val)) {
                    return numberWithSpaces(val);
                }

                return numberWithSpaces(val) + '.00';
            }

            function numberWithSpaces(x) {
                var parts = x.toString().split(".");
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                return parts.join(".");
            }


            // create the Grid
            var grid = new Ext.grid.GridPanel({
                store: store,
                stripeRows: true,
                autoExpandColumn: 'loanStatus',
                height: 350,
                width: 700,
                cls: 'my-panel',
                title: 'История займов по заемщику',
                columns: [
                    {
                        header   : 'Дата',
                        width    : 85,
                        //sortable : true,
                        renderer : Ext.util.Format.dateRenderer('d.m.Y'),
                        dataIndex: 'startDate'
                    },
                    {
                        header   : 'Срок',
                        width    : 80,
                        sortable : true,
                        renderer : daysChange,
                        dataIndex: 'loanTime'
                    },
                    {
                        header   : 'Дата пог.',
                        width    : 85,
                        sortable : true,
                        renderer : Ext.util.Format.dateRenderer('d.m.Y'),
                        dataIndex: 'endDate'
                    },
                    {
                        header   : 'Тело займа',
                        width    : 85,
                        sortable : true,
                        renderer : thoursandSeparator,
                        dataIndex: 'loanBody'
                    },
                    {
                        header   : '%',
                        width    : 40,
                        sortable : true,
                        dataIndex: 'pct'
                    },
                    {
                        header   : 'Сумма + %',
                        width    : 85,
                        sortable : true,
                        renderer : thoursandSeparator,
                        dataIndex: 'totalPctSum'
                    },
                    {
                        id       :'loanStatus',
                        header   : 'Статус',
                        width    : 75,
                        sortable : true,

                        dataIndex: 'status'
                    },
                    {
                        xtype: 'actioncolumn',
                        width: 80,


                        items: [{
                            icon   : './img/icons/print.png',
                            tooltip: 'Печать',
                            iconCls: 'my-icon',
                            handler : function() {
                                window.open (
                                  'about:blank',
                                  '_blank'
                                );
                            }
                        },
                        {

                            icon   : './img/icons/docs.png',
                            tooltip: 'Список документов',
                            //iconCls: 'my-icon',
                            handler : function() {
                                window.open (
                                  'about:blank',
                                  '_blank'
                                )
                            },
                            getClass: function(v, meta, rec) {

                                if (rec.get('status') != 'выдан') {
                                    return 'my-icon x-hide-display';
                                }
                                return 'my-icon';
                            }
                        },
                        {
                            icon   : './img//icons/close.png',
                            tooltip: 'Удалить',
                            iconCls: 'my-icon',
                            handler : function(grid, rowIndex, colIndex) {
                                Ext.MessageBox.buttonText.yes = "Да";
                                Ext.MessageBox.buttonText.no = "Нет";
                                Ext.MessageBox.confirm('Удаление', 'Вы действительно хотите удалить эту запись?', function(btn) {
                                    if (btn === 'yes') {
                                        var rec = store.getAt(rowIndex);
                                        //console.log(rec);
                                        store.remove(rec);
                                    }
                                });
                            }
                        }]
                    },
                ],
                tbar: {
                    height       : 50,
                    layout       : 'hbox',
                    cls: 'my-tbar',
                    layoutConfig : {
                        align : 'middle'
                    },
                    defaults : {
                        //flex : 1
                        cls: 'x-toolbar-standardbutton'
                    },
                    items: [
                        {xtype: 'tbspacer', width: 10}, // add a 10px space
                        {
                            text: 'Выдать займ',
                            icon: './img/icons/money.png',
                            height: 30,
                            style: { 'padding-left': '5px' },
                        },
                        {xtype: 'tbspacer', width: 10}, // add a 10px space
                        {
                            text: 'Просмотр займа',
                            icon: './img/icons/eye.png',
                            height: 30
                        },
                        {xtype: 'tbspacer', width: 10}, // add a 10px space
                        {
                            text: 'Информация',
                            icon: './img/icons/info.png',
                            height: 30
                        }
                    ]
                }
                //renderTo: Ext.getBody()
            });


            //do a Viewport
            new Ext.Viewport({
                layout: {
                    type: 'vbox',
                    align: 'center',
                    pack: 'center'
                },
                items:[grid]
            });

		    // grid.render(document.body);

        }); //end onReady
        </script>

    </head>
    <body>
    </body>
</html>